import hre, { ethers } from "hardhat";
import { Contract } from "ethers";
import { expect } from "chai";
import { HardhatEthersSigner } from "@nomicfoundation/hardhat-ethers/signers";
import { switchForkedNetwork } from "../helpers/switchNetwork";
import { MultiSigCloneFactory } from "../../typechain-types";

describe("Aktionariat Polygon ZCHF Recovery", function () {
  let deployer: HardhatEthersSigner;
  let currentNonce: number;
  
  let contractCreationCodeMultiSig = "0x608060405234801561001057600080fd5b50608060005561202a806100256000396000f3fe6080604052600436106100ec5760003560e01c80638291286c1161008a578063cb6367d111610059578063cb6367d1146102dd578063ce5494bb1461030a578063d69c3d301461032a578063ecec0dfd1461035757600080fd5b80638291286c14610258578063b5fe51631461026d578063b6e404de1461029d578063c4d66de8146102bd57600080fd5b8063736c0d5b116100c6578063736c0d5b146101a5578063775a8f5e146101e75780637ca548c6146102075780637cedbb801461023557600080fd5b80630f43d6781461012d5780631068361f1461014f57806348753d001461016f57600080fd5b366101285760405134815233907f88a5966d370b9919b20f3e2c13ff65706f196a4e32cc2c12bf57088f885258749060200160405180910390a2005b600080fd5b34801561013957600080fd5b5061014d610148366004611a3c565b610377565b005b34801561015b57600080fd5b5061014d61016a3660046119af565b61042b565b34801561017b57600080fd5b5061018f61018a366004611b25565b610492565b60405161019c9190611d1b565b60405180910390f35b3480156101b157600080fd5b506101d56101c0366004611994565b60026020526000908152604090205460ff1681565b60405160ff909116815260200161019c565b3480156101f357600080fd5b5061018f610202366004611c1b565b6105fd565b34801561021357600080fd5b506003546102229061ffff1681565b60405161ffff909116815260200161019c565b34801561024157600080fd5b5061024a606481565b60405190815260200161019c565b34801561026457600080fd5b5061018f6106d3565b34801561027957600080fd5b5061028d610288366004611b0a565b610761565b604051901515815260200161019c565b3480156102a957600080fd5b5061014d6102b83660046119e2565b61079c565b3480156102c957600080fd5b5061014d6102d8366004611994565b610827565b3480156102e957600080fd5b506102fd6102f8366004611a66565b6108b9565b60405161019c9190611cde565b34801561031657600080fd5b5061014d610325366004611994565b610ad7565b34801561033657600080fd5b5061033f610ae4565b6040516001600160801b03909116815260200161019c565b34801561036357600080fd5b506102fd610372366004611b25565b610af8565b3033148061039757503360009081526002602052604090205460ff166001145b6103d95760405162461bcd60e51b815260206004820152600e60248201526d1b9bdd08185d5d1a1bdc9a5e995960921b60448201526064015b60405180910390fd5b6103e38282610b2f565b60035461ffff166104275760405162461bcd60e51b815260206004820152600e60248201526d07369676e657220636f756e7420360941b60448201526064016103d0565b5050565b3033148061044b57503360009081526002602052604090205460ff166001145b6104885760405162461bcd60e51b815260206004820152600e60248201526d1b9bdd08185d5d1a1bdc9a5e995960921b60448201526064016103d0565b6104278282610ccb565b6060600061052e8d600480546104a790611f10565b80601f01602080910402602001604051908101604052809291908181526020018280546104d390611f10565b80156105205780601f106104f557610100808354040283529160200191610520565b820191906000526020600020905b81548152906001019060200180831161050357829003601f168201915b50505050508e8e8e8e610d5c565b90506000610541828a8a8a8a8a8a6108b9565b905060006105948e8d8d8080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050508f611015565b905061059f8f611125565b8d6001600160a01b03167f64ada3f9bcd41ebd407b399dc401184273a19bc294825172626af05a15c95d256105d48e8e61122f565b846040516105e3929190611cf1565b60405180910390a29e9d5050505050505050505050505050565b6060600082600160801b81106106225760809390931c9261061f601083611d70565b91505b6801000000000000000084106106475760409390931c92610644600883611d70565b91505b64010000000084106106685760209390931c92610665600483611d70565b91505b6201000084106106875760109390931c92610684600283611d70565b91505b61010084106106a55760089390931c926106a2600183611d70565b91505b83156106b9576106b6600183611d70565b91505b604080518381016020810190925291905290815292915050565b600480546106e090611f10565b80601f016020809104026020016040519081016040528092919081815260200182805461070c90611f10565b80156107595780601f1061072e57610100808354040283529160200191610759565b820191906000526020600020905b81548152906001019060200180831161073c57829003601f168201915b505050505081565b60008061076d60005490565b905061077981846112eb565b8061079557506107958161078f60005460801c90565b85611330565b9392505050565b6107de8483838080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250889250611015915050565b5060405162461bcd60e51b815260206004820152601760248201527f54657374207061737365642e20526576657274696e672e00000000000000000060448201526064016103d0565b60015460ff16156108705760405162461bcd60e51b8152602060048201526013602482015272185b1c9958591e481a5b9a5d1a585b1a5e9959606a1b60448201526064016103d0565b61087f3063ffffffff166105fd565b805161089391600491602090910190611829565b506003805461ffff191690556108aa816001610b2f565b506001805460ff191681179055565b606060008467ffffffffffffffff8111156108d6576108d6611fde565b6040519080825280602002602001820160405280156108ff578160200160208202803683370190505b5090508461093d5760405162461bcd60e51b815260206004820152600b60248201526a736967206d697373696e6760a81b60448201526064016103d0565b60005b85811015610ac157600060018b8b8b8581811061095f5761095f611fc8565b90506020020160208101906109749190611c34565b8a8a8681811061098657610986611fc8565b9050602002013589898781811061099f5761099f611fc8565b90506020020135604051600081526020016040526040516109dc949392919093845260ff9290921660208401526040830152606082015260800190565b6020604051602081039080840390855afa1580156109fe573d6000803e3d6000fd5b505060408051601f1901516001600160a01b03811660009081526002602052919091205490925060ff1690508015801590610a3c575060ff81168810155b610a795760405162461bcd60e51b815260206004820152600e60248201526d31b7b9b4b3b732b91032b93937b960911b60448201526064016103d0565b81848481518110610a8c57610a8c611fc8565b60200260200101906001600160a01b031690816001600160a01b03168152505050508080610ab990611f6d565b915050610940565b50610acb81611385565b98975050505050505050565b610ae13382610ccb565b50565b60008054610af3906001611d4e565b905090565b60606000610b0d8d600480546104a790611f10565b9050610b1e818989898989896108b9565b9d9c50505050505050505050505050565b6001600160a01b0382163b15610b875760405162461bcd60e51b815260206004820152601b60248201527f7369676e65722063616e6e6f74206265206120636f6e7472616374000000000060448201526064016103d0565b6001600160a01b038216610bca5760405162461bcd60e51b815260206004820152600a602482015269183c181039b4b3b732b960b11b60448201526064016103d0565b6001600160a01b0382166000908152600260205260409020805460ff83811660ff19831617909255168015801590610c03575060ff8216155b15610c3c576003805461ffff16906000610c1c83611ef2565b91906101000a81548161ffff021916908361ffff16021790555050610c85565b60ff8116158015610c50575060008260ff16115b15610c85576003805461ffff16906000610c6983611f4b565b91906101000a81548161ffff021916908361ffff160217905550505b60405160ff831681526001600160a01b038416907f7f00bf87056fc9622b70d830cce34aa24d6c12881ebbc71d3bf22d0c5ae295b79060200160405180910390a2505050565b6001600160a01b03811660009081526002602052604090205460ff1615610d2a5760405162461bcd60e51b815260206004820152601360248201527264657374696e6174696f6e206e6f74206e657760681b60448201526064016103d0565b6001600160a01b038216600090815260026020526040902054610d5190829060ff16610b2f565b610427826000610b2f565b6040805160098082526101408201909252600091829190816020015b6060815260200190600190039081610d78579050509050610da1886001600160801b03166105fd565b81600081518110610db457610db4611fc8565b60200260200101819052508681600181518110610dd357610dd3611fc8565b602002602001018190525060405180604001604052806003815260200162104a4160eb1b81525081600281518110610e0d57610e0d611fc8565b602090810291909101810191909152604051602560fa1b918101919091526bffffffffffffffffffffffff19606088901b16602182015260350160405160208183030381529060405281600381518110610e6957610e69611fc8565b6020026020010181905250610e7d856105fd565b81600481518110610e9057610e90611fc8565b602002602001018190525083838080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250508351849250600591508110610ee657610ee6611fc8565b6020026020010181905250610efa466105fd565b81600681518110610f0d57610f0d611fc8565b60209081029190910181019190915260408051600081529182019052815182906007908110610f3e57610f3e611fc8565b602002602001018190525060005b6008811015610fbe5780600214158015610f67575080600314155b15610fac57610f8e828281518110610f8157610f81611fc8565b6020026020010151611459565b828281518110610fa057610fa0611fc8565b60200260200101819052505b80610fb681611f6d565b915050610f4c565b5080600781518110610fd257610fd2611fc8565b602002602001015181600881518110610fed57610fed611fc8565b6020026020010181905250611001816114c8565b805190602001209150509695505050505050565b606082516000148061103057506001600160a01b0384163b15155b6110735760405162461bcd60e51b81526020600482015260146024820152731d1c985b9cd9995c881bdc8818dbdb9d1c9858dd60621b60448201526064016103d0565b600080856001600160a01b0316848660405161108f9190611c93565b60006040518083038185875af1925050503d80600081146110cc576040519150601f19603f3d011682016040523d82523d6000602084013e6110d1565b606091505b509150915081156110e55791506107959050565b8051156110f457805160208201fd5b60405162461bcd60e51b815260206004820152600660248201526519985a5b195960d21b60448201526064016103d0565b60005480608081901c61113882856112eb565b156111955761119084600161114d8583611e87565b6111579190611e87565b6001600160801b0319600185811b6ffffffffffffffffffffffffffffffffe16176001600160801b039283161b60801b16911617600055565b611229565b6111a0828286611330565b156111f8576111908260016111b58783611e87565b6111bf9190611e87565b6001600160801b03166001901b836001600160801b0316176001600160801b031960809190911b166001600160801b0390911617600055565b60405162461bcd60e51b81526004016103d0906020808252600490820152631d5cd95960e21b604082015260600190565b50505050565b60006004821015611242575060006112e5565b60188383600381811061125757611257611fc8565b909101356001600160f81b03191690911c905060108484600281811061127f5761127f611fc8565b909101356001600160f81b03191690911c90506008858560018181106112a7576112a7611fc8565b909101356001600160f81b03191690911c905085856000816112cb576112cb611fc8565b9050013560f81c60f81b6001600160f81b03191617171790505b92915050565b6000826001600160801b0316826001600160801b0316118015610795575061131d60646001600160801b038516611d70565b826001600160801b031611159392505050565b60008061133d8386611e87565b6001600160801b03169050600081118015611359575060808111155b801561137c57506001600160801b038416611375600183611eaf565b6001901b16155b95945050505050565b60005b815181101561042757600061139e826001611d70565b90505b8251811015611446578281815181106113bc576113bc611fc8565b60200260200101516001600160a01b03168383815181106113df576113df611fc8565b60200260200101516001600160a01b031614156114345760405162461bcd60e51b81526020600482015260136024820152726475706c6963617465207369676e617475726560681b60448201526064016103d0565b8061143e81611f6d565b9150506113a1565b508061145181611f6d565b915050611388565b60608082516001148015611487575060808360008151811061147d5761147d611fc8565b016020015160f81c105b156114935750816112e5565b61149f8351608061150c565b836040516020016114b1929190611caf565b604051602081830303815290604052905092915050565b606060006114d5836116af565b90506114e3815160c061150c565b816040516020016114f5929190611caf565b604051602081830303815290604052915050919050565b606080603884101561157657604080516001808252818301909252906020820181803683370190505090506115418385611d70565b601f1a60f81b8160008151811061155a5761155a611fc8565b60200101906001600160f81b031916908160001a905350610795565b600060015b808610611597578161158c81611f6d565b92505060081b61157b565b6115a2826001611d70565b67ffffffffffffffff8111156115ba576115ba611fde565b6040519080825280601f01601f1916602001820160405280156115e4576020820181803683370190505b5092506115f18583611d70565b6115fc906037611d70565b601f1a60f81b8360008151811061161557611615611fc8565b60200101906001600160f81b031916908160001a905350600190505b8181116116a6576101006116458284611eaf565b61165190610100611ddf565b61165b9088611d88565b6116659190611f88565b601f1a60f81b83828151811061167d5761167d611fc8565b60200101906001600160f81b031916908160001a9053508061169e81611f6d565b915050611631565b50509392505050565b60608151600014156116cf57505060408051600081526020810190915290565b6000805b8351811015611716578381815181106116ee576116ee611fc8565b602002602001015151826117029190611d70565b91508061170e81611f6d565b9150506116d3565b60008267ffffffffffffffff81111561173157611731611fde565b6040519080825280601f01601f19166020018201604052801561175b576020820181803683370190505b50600092509050602081015b85518310156117c557600086848151811061178457611784611fc8565b6020026020010151905060006020820190506117a2838284516117ce565b81516117ae9084611d70565b9250505082806117bd90611f6d565b935050611767565b50949350505050565b8282825b6020811061180a57815183526117e9602084611d70565b92506117f6602083611d70565b9150611803602082611eaf565b90506117d2565b9051825160001960039390931b9290921c918216911916179052505050565b82805461183590611f10565b90600052602060002090601f016020900481019282611857576000855561189d565b82601f1061187057805160ff191683800117855561189d565b8280016001018555821561189d579182015b8281111561189d578251825591602001919060010190611882565b506118a99291506118ad565b5090565b5b808211156118a957600081556001016118ae565b80356001600160a01b03811681146118d957600080fd5b919050565b60008083601f8401126118f057600080fd5b50813567ffffffffffffffff81111561190857600080fd5b6020830191508360208260051b850101111561192357600080fd5b9250929050565b60008083601f84011261193c57600080fd5b50813567ffffffffffffffff81111561195457600080fd5b60208301915083602082850101111561192357600080fd5b80356001600160801b03811681146118d957600080fd5b803560ff811681146118d957600080fd5b6000602082840312156119a657600080fd5b610795826118c2565b600080604083850312156119c257600080fd5b6119cb836118c2565b91506119d9602084016118c2565b90509250929050565b600080600080606085870312156119f857600080fd5b611a01856118c2565b935060208501359250604085013567ffffffffffffffff811115611a2457600080fd5b611a308782880161192a565b95989497509550505050565b60008060408385031215611a4f57600080fd5b611a58836118c2565b91506119d960208401611983565b60008060008060008060006080888a031215611a8157600080fd5b87359650602088013567ffffffffffffffff80821115611aa057600080fd5b611aac8b838c016118de565b909850965060408a0135915080821115611ac557600080fd5b611ad18b838c016118de565b909650945060608a0135915080821115611aea57600080fd5b50611af78a828b016118de565b989b979a50959850939692959293505050565b600060208284031215611b1c57600080fd5b6107958261196c565b600080600080600080600080600080600060e08c8e031215611b4657600080fd5b611b4f8c61196c565b9a50611b5d60208d016118c2565b995060408c0135985067ffffffffffffffff8060608e01351115611b8057600080fd5b611b908e60608f01358f0161192a565b909950975060808d0135811015611ba657600080fd5b611bb68e60808f01358f016118de565b909750955060a08d0135811015611bcc57600080fd5b611bdc8e60a08f01358f016118de565b909550935060c08d0135811015611bf257600080fd5b50611c038d60c08e01358e016118de565b81935080925050509295989b509295989b9093969950565b600060208284031215611c2d57600080fd5b5035919050565b600060208284031215611c4657600080fd5b61079582611983565b600081518084526020808501945080840160005b83811015611c885781516001600160a01b031687529582019590820190600101611c63565b509495945050505050565b60008251611ca5818460208701611ec6565b9190910192915050565b60008351611cc1818460208801611ec6565b835190830190611cd5818360208801611ec6565b01949350505050565b6020815260006107956020830184611c4f565b63ffffffff60e01b83168152604060208201526000611d136040830184611c4f565b949350505050565b6020815260008251806020840152611d3a816040850160208701611ec6565b601f01601f19169190910160400192915050565b60006001600160801b03808316818516808303821115611cd557611cd5611f9c565b60008219821115611d8357611d83611f9c565b500190565b600082611d9757611d97611fb2565b500490565b600181815b80851115611dd7578160001904821115611dbd57611dbd611f9c565b80851615611dca57918102915b93841c9390800290611da1565b509250929050565b60006107958383600082611df5575060016112e5565b81611e02575060006112e5565b8160018114611e185760028114611e2257611e3e565b60019150506112e5565b60ff841115611e3357611e33611f9c565b50506001821b6112e5565b5060208310610133831016604e8410600b8410161715611e61575081810a6112e5565b611e6b8383611d9c565b8060001904821115611e7f57611e7f611f9c565b029392505050565b60006001600160801b0383811690831681811015611ea757611ea7611f9c565b039392505050565b600082821015611ec157611ec1611f9c565b500390565b60005b83811015611ee1578181015183820152602001611ec9565b838111156112295750506000910152565b600061ffff821680611f0657611f06611f9c565b6000190192915050565b600181811c90821680611f2457607f821691505b60208210811415611f4557634e487b7160e01b600052602260045260246000fd5b50919050565b600061ffff80831681811415611f6357611f63611f9c565b6001019392505050565b6000600019821415611f8157611f81611f9c565b5060010190565b600082611f9757611f97611fb2565b500690565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052601260045260246000fd5b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052604160045260246000fdfea2646970667358221220d139271639e44a932c1c18d786bb9f72ee98694c5e8e0abfff16ebc15da2ae4a64736f6c63430008070033"

  let contractCreationCodeCloneMaster = "0x60a060405234801561001057600080fd5b5060405161040538038061040583398101604081905261002f91610044565b60601b6001600160601b031916608052610074565b60006020828403121561005657600080fd5b81516001600160a01b038116811461006d57600080fd5b9392505050565b60805160601c61036861009d60003960008181607a0152818160b6015260e901526103686000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c80630e787cce1461004657806364293af314610075578063a3def9231461009c575b600080fd5b610059610054366004610319565b6100af565b6040516001600160a01b03909116815260200160405180910390f35b6100597f000000000000000000000000000000000000000000000000000000000000000081565b6100596100aa3660046102e1565b6100e1565b60006100db7f0000000000000000000000000000000000000000000000000000000000000000836101d0565b92915050565b60008061010e7f00000000000000000000000000000000000000000000000000000000000000008461023d565b60405163189acdbd60e31b81526001600160a01b0386811660048301529192509082169063c4d66de890602401600060405180830381600087803b15801561015557600080fd5b505af1158015610169573d6000803e3d6000fd5b5050505060405161018e906d135d5b1d1a54da59d5d85b1b195d60921b8152600e0190565b604051908190038120906001600160a01b038316907f5748f17320a7bfc4dad968e541c61b9fa9923765f9efdfa3dffc76763e02d19690600090a39392505050565b6000610236838330604051733d602d80600a3d3981f3363d3d373d3d3d363d7360601b8152606093841b60148201526f5af43d82803e903d91602b57fd5bf3ff60801b6028820152921b6038830152604c8201526037808220606c830152605591012090565b9392505050565b6000604051733d602d80600a3d3981f3363d3d373d3d3d363d7360601b81528360601b60148201526e5af43d82803e903d91602b57fd5bf360881b6028820152826037826000f59150506001600160a01b0381166100db5760405162461bcd60e51b815260206004820152601760248201527f455243313136373a2063726561746532206661696c6564000000000000000000604482015260640160405180910390fd5b600080604083850312156102f457600080fd5b82356001600160a01b038116811461030b57600080fd5b946020939093013593505050565b60006020828403121561032b57600080fd5b503591905056fea2646970667358221220678d3966199a6285118bf31211c62b32fc000c0a4f55c4394a51ccbb8b8e5bf764736f6c6343000807003300000000000000000000000043ffaa65fe273d2ef9edd78418091d41b1aa40e8"
  
  let contractABI = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Received","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"signer","type":"address"},{"indexed":false,"internalType":"uint8","name":"signaturesNeeded","type":"uint8"}],"name":"SignerChange","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"toAddress","type":"address"},{"indexed":false,"internalType":"bytes4","name":"selector","type":"bytes4"},{"indexed":false,"internalType":"address[]","name":"signers","type":"address[]"}],"name":"Transacted","type":"event"},{"inputs":[],"name":"MAX_INCREASE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"checkExecution","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint128","name":"nonce","type":"uint128"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"},{"internalType":"uint8[]","name":"v","type":"uint8[]"},{"internalType":"bytes32[]","name":"r","type":"bytes32[]"},{"internalType":"bytes32[]","name":"s","type":"bytes32[]"}],"name":"checkSignatures","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"contractId","outputs":[{"internalType":"bytes","name":"","type":"bytes"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint128","name":"nonce","type":"uint128"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"},{"internalType":"uint8[]","name":"v","type":"uint8[]"},{"internalType":"bytes32[]","name":"r","type":"bytes32[]"},{"internalType":"bytes32[]","name":"s","type":"bytes32[]"}],"name":"execute","outputs":[{"internalType":"bytes","name":"","type":"bytes"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint128","name":"nonce","type":"uint128"}],"name":"isFree","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"source","type":"address"},{"internalType":"address","name":"destination","type":"address"}],"name":"migrate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"destination","type":"address"}],"name":"migrate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"nextNonce","outputs":[{"internalType":"uint128","name":"","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"signer","type":"address"},{"internalType":"uint8","name":"signaturesNeeded","type":"uint8"}],"name":"setSigner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"signerCount","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"signers","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"}],"name":"toBytes","outputs":[{"internalType":"bytes","name":"result","type":"bytes"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"bytes32","name":"transactionHash","type":"bytes32"},{"internalType":"uint8[]","name":"v","type":"uint8[]"},{"internalType":"bytes32[]","name":"r","type":"bytes32[]"},{"internalType":"bytes32[]","name":"s","type":"bytes32[]"}],"name":"verifySignatures","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}]
  
  let targetDeterministicAddressMultiSig = "0x4Fd9DbA1d53B7E6cC933a2Fdd12B1c012a0654F6";
  let multisSigCloneFactory: MultiSigCloneFactory;
  let multiSigWalletMaster: Contract;

  before(async function() {
    await switchForkedNetwork("polygon");
    [deployer] = await ethers.getSigners();
    currentNonce = await deployer.getNonce()
  });

  it("Should have correct deployer 0x39E5351", async function () {
    expect(deployer.address).to.equal("0x39E5351E6CE3c4B19B8b0a2F5C82c511782457BE");
  });

  it("Should start with a nonce less than the required nonce", async function () {
    currentNonce = await deployer.getNonce();
    expect(currentNonce).to.be.lessThanOrEqual(139);
  });

  it("Should send empty transactions until required nonce is reached", async function () {
    for (let i = currentNonce ; i < 139; i++) {
      await deployer.sendTransaction({ to: deployer.address, value: ethers.parseEther("0.0"),  });
      currentNonce = await deployer.getNonce();
    }

    expect(currentNonce).to.equal(139);
  });

  it("Should deploy MultiSigWalletV3 at correct nonce to pretermined address", async function () {
    currentNonce = await deployer.getNonce();
    expect(currentNonce).to.equal(139);

    const contractFactory = await ethers.getContractFactory([], contractCreationCodeMultiSig, deployer);
    const deployedContract = await contractFactory.deploy();
    const dep = await deployedContract.waitForDeployment();
    expect(dep.target).to.equal("0x43Ffaa65fe273D2EF9EDd78418091d41B1AA40E8");
  });

  it("Should skip nonces and deploy MultiSigCloneFactory at correct nonce to pretermined address", async function () {
    currentNonce = await deployer.getNonce();
    expect(currentNonce).to.equal(140);

    const contractFactory = await ethers.getContractFactory([], contractCreationCodeCloneMaster, deployer);
    const deployedContract = await contractFactory.deploy();
    const dep = await deployedContract.waitForDeployment();
    expect(dep.target).to.equal("0xC894ef112CC26741397053248F9f677398Eb56e2");
  });

  it("Should be able to correctly predict the deployed multisig", async function () {
    multisSigCloneFactory = await ethers.getContractAt("MultiSigCloneFactory", "0xC894ef112CC26741397053248F9f677398Eb56e2");
    let predictedAdress = await multisSigCloneFactory.connect(deployer).predict("0x6669787632330000000000000000000000000000000000000000000000000000");
    expect(predictedAdress).to.equal(targetDeterministicAddressMultiSig);
  });

  it("Should use deployed MultiSigCloneFactory to deploy a MultiSig Clone with correct salt", async function () {
    multisSigCloneFactory = await ethers.getContractAt("MultiSigCloneFactory", "0xC894ef112CC26741397053248F9f677398Eb56e2");
    await multisSigCloneFactory.connect(deployer).create("0x59f0941e75f2f77ca4577e48c3c5333a3f8d277b", "0x6669787632330000000000000000000000000000000000000000000000000000");
  });

  it("Should now have some code at 0x4Fd9DbA1d53B7E6cC933a2Fdd12B1c012a0654F6", async function () {
    expect(await ethers.provider.getCode(targetDeterministicAddressMultiSig)).to.not.equal("0x");
  });

  it("Should be able to call methods of the deployed multisig", async function () {
    multiSigWalletMaster = await ethers.getContractAt(contractABI, targetDeterministicAddressMultiSig, deployer);
    expect(await multiSigWalletMaster.signerCount()).to.equal(1);
    expect(await multiSigWalletMaster.signers("0x59f0941e75f2f77ca4577e48c3c5333a3f8d277b")).to.equal(1);
  });

});